# ОТЧЕТ ПО ЛАБОРАТОРНОЙ РАБОТЕ 13
## Тема: Работа с БД. Работа со свойствами класса
## Цель: изучить работу со свойствами класса

---

## **1. СТРУКТУРА БАЗЫ ДАННЫХ**

### Обновленная схема БД для ЛР-13:

**Таблица Product** (без изменений):
- ProductId (PK) - идентификатор продукта
- ProductName - наименование продукта  
- Price - цена продукта
- Category - категория
- ExpiryDays - срок годности в днях
- Description - описание

**Таблица Sale** (добавлены новые поля):
- SaleId (PK) - идентификатор продажи
- SaleDate - дата продажи
- CustomerName - имя покупателя
- TotalAmount - общая сумма (старое поле)
- **SummaSale** - сумма всех продуктов (новое поле)
- **DiscountSale** - скидка в процентах (новое поле)
- **Resultat** - итоговая сумма с учетом скидки (новое поле)

**Таблица SaleDetails** (добавлено новое поле):
- SaleDetailId (PK) - идентификатор детали
- SaleId (FK) - ссылка на продажу
- ProductId (FK) - ссылка на продукт
- Quantity - количество
- UnitPrice - цена за единицу
- **SummaProduct** - стоимость позиции (новое поле)

---

## **2. ВЫЧИСЛЯЕМЫЕ СВОЙСТВА В КЛАССАХ**

### 2.1 Класс Sale - вычисляемые свойства:

```csharp
/// <summary>
/// Вычисляемое свойство: Сумма всех продуктов в данной продаже
/// Формула: SUM(Quantity * UnitPrice) для всех SaleDetails этой продажи
/// </summary>
[NotMapped]
public decimal SummaSaleCalculated
{
    get
    {
        if (SaleDetails != null && SaleDetails.Any())
        {
            return SaleDetails.Sum(detail => detail.QuantityProduct * detail.UnitPrice);
        }
        return 0;
    }
}

/// <summary>
/// Вычисляемое свойство: Итоговая сумма с учетом скидки
/// Формула: SummaSale - (SummaSale * DiscountSale / 100)
/// </summary>
[NotMapped]
public decimal ResultatCalculated
{
    get
    {
        decimal summa = SummaSaleCalculated;
        decimal discount = DiscountSale ?? 0;
        return summa - (summa * discount / 100);
    }
}

/// <summary>
/// Вычисляемое свойство: Размер скидки в рублях
/// </summary>
[NotMapped]
public decimal DiscountAmount
{
    get
    {
        decimal summa = SummaSaleCalculated;
        decimal discount = DiscountSale ?? 0;
        return summa * discount / 100;
    }
}
```

### 2.2 Класс SaleDetails - вычисляемые свойства:

```csharp
/// <summary>
/// Вычисляемое свойство: Стоимость позиции
/// Формула: Quantity * UnitPrice
/// </summary>
[NotMapped]
public decimal SummaProductCalculated
{
    get
    {
        return QuantityProduct * UnitPrice;
    }
}

/// <summary>
/// Вычисляемое свойство: Стоимость позиции через цену из Product
/// Формула: Quantity * Product.priceProduct
/// </summary>
[NotMapped]
public decimal SummaProductFromProductPrice
{
    get
    {
        if (Product != null)
        {
            return QuantityProduct * Product.priceProduct;
        }
        return 0;
    }
}

/// <summary>
/// Вычисляемое свойство: Экономия при покупке
/// </summary>
[NotMapped]
public decimal PriceDifference
{
    get
    {
        if (Product != null)
        {
            return (Product.priceProduct - UnitPrice) * QuantityProduct;
        }
        return 0;
    }
}
```

---

## **3. ИНТЕРФЕЙС ПОЛЬЗОВАТЕЛЯ**

### 3.1 DataGrid для таблицы Sale:
- Отображает все продажи с вычисляемыми свойствами
- Столбцы: ID, Дата, Покупатель, Кол-во позиций, Сумма (вычисл.), Скидка %, Скидка ₽, Итого (вычисл.), Сумма (БД), Итого (БД)
- Сравнение вычисляемых значений с сохраненными в БД

### 3.2 DataGrid для таблицы SaleDetails:
- Отображает все позиции продаж с вычисляемыми свойствами
- Столбцы: ID, ID Продажи, Товар, Количество, Цена за ед., Стоимость (вычисл.), Стоимость (БД), Цена в каталоге, Разница цен

### 3.3 Функциональные кнопки:
- **Загрузить продажи** - загрузка данных Sale с Include для SaleDetails
- **Загрузить детали** - загрузка данных SaleDetails с Include для Product
- **Пересчитать и сохранить** - обновление полей БД на основе вычисляемых свойств

---

## **4. КЛЮЧЕВЫЕ ОСОБЕННОСТИ РЕАЛИЗАЦИИ**

### 4.1 Атрибут [NotMapped]:
```csharp
[NotMapped]
public decimal SummaSaleCalculated { get; }
```
- Указывает Entity Framework, что это свойство не должно сохраняться в БД
- Свойство существует только в памяти для вычислений

### 4.2 Include для загрузки связанных данных:
```csharp
var sales = db.Sale
    .Include(s => s.SaleDetails)
    .ThenInclude(sd => sd.Product)
    .ToList();
```
- Без Include вычисляемые свойства не будут работать
- ThenInclude загружает данные Product для каждого SaleDetails

### 4.3 Синхронизация вычисляемых свойств с БД:
```csharp
foreach (var sale in sales)
{
    // Используем вычисляемые свойства для обновления полей БД
    sale.SummaSale = sale.SummaSaleCalculated;
    sale.Resultat = sale.ResultatCalculated;
}
db.SaveChanges();
```

---

## **5. ДЕМОНСТРАЦИЯ РАБОТЫ**

### 5.1 Что показывает приложение:
1. **Автоматический расчет** стоимости позиций (Quantity × UnitPrice)
2. **Автоматический расчет** суммы продажи (сумма всех позиций)
3. **Автоматический расчет** итоговой суммы с учетом скидки
4. **Сравнение** вычисляемых значений с сохраненными в БД
5. **Обновление** полей БД на основе вычисляемых свойств

### 5.2 Формулы, используемые в работе:
- `SummaProduct = Quantity × UnitPrice`
- `SummaSale = SUM(SummaProduct)` для всех позиций продажи
- `Resultat = SummaSale - (SummaSale × DiscountSale / 100)`
- `DiscountAmount = SummaSale × DiscountSale / 100`

---

## **6. ВЫВОДЫ**

1. **Вычисляемые свойства** позволяют автоматически рассчитывать значения на основе других полей
2. **Атрибут [NotMapped]** исключает свойства из сохранения в БД
3. **Include/ThenInclude** необходимы для работы вычисляемых свойств со связанными данными
4. **Двойное хранение** (вычисляемое + в БД) позволяет сравнивать и синхронизировать данные
5. **Привязка данных** автоматически отображает изменения вычисляемых свойств в UI

Лабораторная работа успешно демонстрирует работу со свойствами класса в контексте Entity Framework и WPF Data Binding.