# ОТЧЕТ ПО ЛАБОРАТОРНОЙ РАБОТЕ № 14
## Тема: Работа со свойствами классов, работа с изображениями

### ВЫПОЛНИЛ: [ФИО студента]
### ГРУППА: [Номер группы]
### ДАТА: [Дата выполнения]

---

## ЦЕЛЬ РАБОТЫ
Изучить работу с изображениями в WPF приложениях:
- Часть 1: Работа с изображениями из файловой системы
- Часть 2: Работа с изображениями, хранящимися в базе данных (varbinary)

---

## ЧАСТЬ 1: РАБОТА С ИЗОБРАЖЕНИЯМИ ИЗ ФАЙЛОВОЙ СИСТЕМЫ

### 1.1. ПОДГОТОВКА БАЗЫ ДАННЫХ

**Задача:** Добавить поле `photo` в таблицу Product для хранения имени файла изображения.

**SQL код для обновления БД:**
```sql
-- Добавляем поле photo в таблицу Product
ALTER TABLE Product ADD 
    photo NVARCHAR(255) NULL;

-- Заполняем поле photo для существующих продуктов
UPDATE Product SET photo = 
    CASE ProductId
        WHEN 1 THEN '1.jpg'        -- Молоко
        WHEN 2 THEN '2.jpg'        -- Кефир  
        WHEN 3 THEN NULL           -- Творог (без изображения)
        WHEN 4 THEN '4.jpg'        -- Сметана
        WHEN 5 THEN NULL           -- Йогурт (без изображения)
        WHEN 6 THEN '6.png'        -- Масло
        WHEN 7 THEN '7.jpg'        -- Сыр
        WHEN 8 THEN NULL           -- Ряженка (без изображения)
        ELSE NULL
    END;
```

**Результат:** В таблице Product появилось поле `photo`, некоторые продукты получили имена файлов изображений, некоторые остались без изображений (будут использовать заглушку).

### 1.2. СОЗДАНИЕ ПАПКИ IMAGES И ЗАГЛУШКИ

**Задача:** Создать папку Images в папке Debug приложения и добавить заглушку picture.jpg.

**Структура папки Images:**
```
MilkProductsBinding/
├── bin/Debug/net6.0-windows/Images/
│   ├── 1.jpg          # Изображение для продукта ID=1
│   ├── 2.jpg          # Изображение для продукта ID=2  
│   ├── 4.jpg          # Изображение для продукта ID=4
│   ├── 6.png          # Изображение для продукта ID=6
│   ├── 7.jpg          # Изображение для продукта ID=7
│   └── picture.jpg    # Заглушка для продуктов без изображения
```

### 1.3. ОБНОВЛЕНИЕ МОДЕЛИ PRODUCT

**Задача:** Добавить поле `photo` и вычисляемое свойство `pathFoto` в класс Product.

**C# код модели Product.cs:**
```csharp
// НОВОЕ ПОЛЕ для ЛР-14: Имя файла изображения
[StringLength(255)]
public string? photo { get; set; }

/// <summary>
/// Вычисляемое свойство pathFoto: Полный путь к изображению продукта
/// Логика: если photo не null - используем его, иначе заглушка picture.jpg
/// </summary>
[NotMapped]
public string pathFoto
{
    get
    {
        if (photo != null && !string.IsNullOrEmpty(photo.Trim()))
        {
            return Directory.GetCurrentDirectory() + @"\Images\" + photo.Trim();
        }
        return Directory.GetCurrentDirectory() + @"\Images\picture.jpg";
    }
}
```

**Объяснение:**
- `photo` - поле для хранения имени файла изображения
- `pathFoto` - вычисляемое свойство, которое возвращает полный путь к изображению
- Если `photo` не пустое - используется указанный файл
- Если `photo` пустое или NULL - используется заглушка `picture.jpg`

### 1.4. СОЗДАНИЕ DATAGRID С ИЗОБРАЖЕНИЯМИ

**Задача:** Создать DataGrid для отображения продуктов с изображениями.

**XAML код для DataGrid:**
```xml
<DataGrid x:Name="dgProducts" AutoGenerateColumns="False" 
          CanUserAddRows="False" IsReadOnly="True" 
          RowHeight="80">
    <DataGrid.Columns>
        <DataGridTextColumn Header="ID" Binding="{Binding idProduct}" Width="50"/>
        
        <!-- Столбец с изображением -->
        <DataGridTemplateColumn Header="Фото" Width="100">
            <DataGridTemplateColumn.CellTemplate>
                <DataTemplate>
                    <Border BorderBrush="Gray" BorderThickness="1" Margin="2">
                        <Image Source="{Binding pathFoto}" 
                               Width="70" Height="70" 
                               Stretch="UniformToFill"
                               ToolTip="{Binding pathFoto}"/>
                    </Border>
                </DataTemplate>
            </DataGridTemplateColumn.CellTemplate>
        </DataGridTemplateColumn>
        
        <DataGridTextColumn Header="Наименование" Binding="{Binding nameProduct}" Width="180"/>
        <DataGridTextColumn Header="Цена" Binding="{Binding priceProduct, StringFormat=F2}" Width="80"/>
        <DataGridTextColumn Header="Путь к изображению" Binding="{Binding pathFoto}" Width="200"/>
    </DataGrid.Columns>
</DataGrid>
```

**Ключевые моменты:**
- `DataGridTemplateColumn` для отображения изображений
- `Image.Source="{Binding pathFoto}"` - привязка к вычисляемому свойству
- `Stretch="UniformToFill"` - масштабирование изображения
- `ToolTip` показывает полный путь к файлу

### 1.5. СОЗДАНИЕ LISTVIEW - КАТАЛОГ ТОВАРОВ

**Задача:** Создать ListView для отображения каталога товаров в виде плиток с изображениями.

**XAML код для ListView:**
```xml
<ListView x:Name="lvProducts" 
          ScrollViewer.HorizontalScrollBarVisibility="Disabled">
    <ListView.ItemsPanel>
        <ItemsPanelTemplate>
            <WrapPanel Orientation="Horizontal"/>
        </ItemsPanelTemplate>
    </ListView.ItemsPanel>
    
    <ListView.ItemTemplate>
        <DataTemplate>
            <Border BorderBrush="LightGray" BorderThickness="2" 
                    CornerRadius="5" Margin="5" Padding="10"
                    Background="White" Width="200" Height="280">
                <StackPanel>
                    <!-- Изображение продукта -->
                    <Border BorderBrush="Gray" BorderThickness="1" 
                            HorizontalAlignment="Center" Margin="0,0,0,10">
                        <Image Source="{Binding pathFoto}" 
                               Width="150" Height="150" 
                               Stretch="UniformToFill"/>
                    </Border>
                    
                    <!-- Информация о продукте -->
                    <TextBlock Text="{Binding nameProduct}" 
                               FontWeight="Bold" FontSize="14" 
                               TextWrapping="Wrap" HorizontalAlignment="Center"/>
                    
                    <TextBlock Text="{Binding priceProduct, StringFormat='Цена: {0:F2} ₽'}" 
                               FontSize="12" HorizontalAlignment="Center"
                               Foreground="Green" FontWeight="Bold"/>
                </StackPanel>
            </Border>
        </DataTemplate>
    </ListView.ItemTemplate>
</ListView>
```

**Особенности ListView:**
- `WrapPanel` для размещения элементов в несколько рядов
- Каждый товар отображается как карточка с изображением
- Красивое оформление с рамками и отступами

### 1.6. C# КОД ДЛЯ ЗАГРУЗКИ ДАННЫХ

**C# код в Lab14Window.xaml.cs:**
```csharp
private void LoadProducts()
{
    try
    {
        // Загружаем все продукты
        allProducts = db.Product.ToList();
        dgProducts.ItemsSource = allProducts;
        
        // Статистика по изображениям
        int withImages = allProducts.Count(p => p.HasImage);
        int withoutImages = allProducts.Count - withImages;
        
        tbProductInfo.Text = $"Загружено продуктов: {allProducts.Count} | " +
                            $"С фото: {withImages}, Без фото: {withoutImages}";
    }
    catch (Exception ex)
    {
        MessageBox.Show($"Ошибка загрузки продуктов: {ex.Message}", "Ошибка");
    }
}
```

---

## ЧАСТЬ 2: РАБОТА С ИЗОБРАЖЕНИЯМИ В БАЗЕ ДАННЫХ

### 2.1. СОЗДАНИЕ НОВОГО ПРОЕКТА

**Задача:** Создать отдельный WPF проект для работы с изображениями в БД.

**Название проекта:** MilkProductsImages

**Структура проекта:**
```
MilkProductsImages/
├── Models/
│   ├── ProductWithImage.cs    # Модель с полем varbinary
│   └── ImageContext.cs        # DbContext для работы с БД
├── MainWindow.xaml            # Интерфейс
├── MainWindow.xaml.cs         # Логика
└── InverseBooleanToVisibilityConverter.cs  # Конвертер
```

### 2.2. СОЗДАНИЕ МОДЕЛИ С VARBINARY

**C# код ProductWithImage.cs:**
```csharp
[Table("ProductWithImage")]
public partial class ProductWithImage
{
    [Key]
    public int IdProduct { get; set; }
    
    [Required]
    [StringLength(100)]
    public string NameProduct { get; set; } = null!;
    
    [Column("Price", TypeName = "decimal(10, 2)")]
    public decimal PriceProduct { get; set; }
    
    // НОВОЕ ПОЛЕ для изображения в БД
    [Column("ProductImage", TypeName = "varbinary(max)")]
    public byte[]? ProductImage { get; set; }
    
    [StringLength(100)]
    public string? ImageFileName { get; set; }
    
    /// <summary>
    /// Вычисляемое свойство: BitmapImage для отображения в WPF
    /// </summary>
    [NotMapped]
    public BitmapImage? ImageSource
    {
        get
        {
            if (ProductImage == null || ProductImage.Length == 0) 
                return null;

            try
            {
                using (var stream = new MemoryStream(ProductImage))
                {
                    var bitmap = new BitmapImage();
                    bitmap.BeginInit();
                    bitmap.CacheOption = BitmapCacheOption.OnLoad;
                    bitmap.StreamSource = stream;
                    bitmap.EndInit();
                    bitmap.Freeze();
                    return bitmap;
                }
            }
            catch
            {
                return null;
            }
        }
    }
}
```

### 2.3. МЕТОДЫ ДЛЯ РАБОТЫ С ИЗОБРАЖЕНИЯМИ

**C# код для загрузки изображения из файла:**
```csharp
/// <summary>
/// Метод для загрузки изображения из файла в byte[]
/// </summary>
public void LoadImageFromFile(string filePath)
{
    if (!File.Exists(filePath))
        throw new FileNotFoundException($"Файл не найден: {filePath}");

    try
    {
        ProductImage = File.ReadAllBytes(filePath);
        ImageFileName = Path.GetFileName(filePath);
        ImageFileSize = ProductImage.Length;
        
        // Определяем тип контента по расширению
        string extension = Path.GetExtension(filePath).ToLower();
        ImageContentType = extension switch
        {
            ".jpg" or ".jpeg" => "image/jpeg",
            ".png" => "image/png",
            ".bmp" => "image/bmp",
            _ => "image/unknown"
        };
    }
    catch (Exception ex)
    {
        throw new InvalidOperationException($"Ошибка загрузки: {ex.Message}");
    }
}
```

### 2.4. DATAGRID С ИЗОБРАЖЕНИЯМИ ИЗ БД

**XAML код:**
```xml
<DataGrid x:Name="dgProducts" AutoGenerateColumns="False" 
          RowHeight="100">
    <DataGrid.Columns>
        <!-- Столбец с изображением из БД -->
        <DataGridTemplateColumn Header="Изображение из БД" Width="120">
            <DataGridTemplateColumn.CellTemplate>
                <DataTemplate>
                    <Border BorderBrush="Gray" BorderThickness="1">
                        <Grid>
                            <!-- Изображение, если есть -->
                            <Image Source="{Binding ImageSource}" 
                                   Width="90" Height="90" 
                                   Stretch="UniformToFill"/>
                            
                            <!-- Заглушка, если нет изображения -->
                            <TextBlock Text="НЕТ&#x0A;ФОТО" 
                                       HorizontalAlignment="Center" 
                                       VerticalAlignment="Center"
                                       FontSize="10" FontWeight="Bold"
                                       Foreground="Gray"/>
                        </Grid>
                    </Border>
                </DataTemplate>
            </DataGridTemplateColumn.CellTemplate>
        </DataGridTemplateColumn>
        
        <DataGridTextColumn Header="Наименование" Binding="{Binding NameProduct}"/>
        <DataGridTextColumn Header="Статус изображения" Binding="{Binding ImageStatus}"/>
    </DataGrid.Columns>
</DataGrid>
```

---

## РЕЗУЛЬТАТЫ ВЫПОЛНЕНИЯ

### ЧТО ПОЛУЧИЛОСЬ:

1. **Часть 1 - Файловая система:**
   - ✅ Добавлено поле `photo` в таблицу Product
   - ✅ Создана папка Images с изображениями и заглушкой
   - ✅ Реализовано вычисляемое свойство `pathFoto`
   - ✅ DataGrid отображает продукты с изображениями
   - ✅ ListView показывает каталог товаров в виде плиток

2. **Часть 2 - База данных:**
   - ✅ Создан отдельный проект MilkProductsImages
   - ✅ Создана таблица ProductWithImage с полем varbinary(max)
   - ✅ Реализованы методы загрузки/сохранения изображений
   - ✅ DataGrid отображает изображения из БД
   - ✅ Возможность загрузки изображений в БД

### ДЕМОНСТРАЦИЯ ВЫЧИСЛЯЕМЫХ СВОЙСТВ:

- `pathFoto` - автоматически формирует путь к изображению
- `ImageSource` - преобразует byte[] в BitmapImage для WPF
- `HasImageInDatabase` - проверяет наличие изображения в БД
- `ImageSizeFormatted` - показывает размер в удобном формате

### СКРИНШОТЫ:
[Здесь должны быть скриншоты работающего приложения]

---

## ВЫВОДЫ

В ходе выполнения ЛР-14 изучены два способа работы с изображениями в WPF:

1. **Файловая система** - простой способ, изображения хранятся отдельно
2. **База данных** - сложный способ, изображения хранятся в БД как varbinary

Оба подхода имеют свои преимущества и недостатки. Выбор зависит от требований конкретного проекта.