# ОТЧЕТ - Лабораторная работа 11
## Тема: Привязки данных Binding. Работа с БД.

### Выполнил: [ФИО студента]
### Группа: [Номер группы]
### Дата: [Дата выполнения]

---

## А) Код XAML

### MainWindow.xaml - Основное окно с привязками данных

```xaml
<Window x:Class="MilkProductsBinding.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Лабораторная работа 11 - Привязки данных Binding" Height="700" Width="1000"
        WindowStartupLocation="CenterScreen">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Заголовок -->
        <TextBlock Grid.Row="0" Grid.ColumnSpan="4" 
                   Text="Привязки данных Binding - Молочные продукты" 
                   FontSize="20" FontWeight="Bold" 
                   HorizontalAlignment="Center" Margin="10"/>

        <!-- 1. Простая привязка к Product -->
        <GroupBox Grid.Column="0" Grid.Row="1" Header="1. Простая привязка - Product" Margin="5">
            <StackPanel x:Name="stProduct" Orientation="Vertical">
                <TextBlock Text="Артикул" FontWeight="Bold"/>
                <TextBox Text="{Binding idProduct}" Margin="2"/>
                <TextBlock Text="Наименование" FontWeight="Bold"/>
                <TextBox Text="{Binding nameProduct, Mode=TwoWay}" Margin="2"/>
                <TextBlock Text="Цена" FontWeight="Bold"/>
                <TextBox Text="{Binding priceProduct, Mode=TwoWay}" Margin="2"/>
                <TextBlock Text="Категория" FontWeight="Bold"/>
                <TextBox Text="{Binding Category}" Margin="2"/>
            </StackPanel>
        </GroupBox>

        <!-- 2. Сложная привязка к SaleDetails -->
        <GroupBox Grid.Column="1" Grid.Row="1" Header="2. Сложная привязка - SaleDetails" Margin="5">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                
                <StackPanel x:Name="stDetail" Grid.Row="0" Orientation="Vertical">
                    <TextBlock Text="ID Детали" Foreground="DarkBlue" FontWeight="Bold"/>
                    <TextBox Text="{Binding IdDetailSale}" Margin="2"/>
                    <TextBlock Text="Артикул" Foreground="DarkBlue" FontWeight="Bold"/>
                    <TextBox x:Name="txtArticul" Text="{Binding IdProductDetailSale}" Margin="2"/>
                    <TextBlock Text="Наименование" Foreground="DarkBlue" FontWeight="Bold"/>
                    <TextBox x:Name="txtNameProduct" Text="{Binding Product.nameProduct}" Margin="2"/>
                    <TextBlock Text="Цена" Foreground="DarkBlue" FontWeight="Bold"/>
                    <TextBox x:Name="txtPriceProduct" Text="{Binding Product.priceProduct}" Margin="2"/>
                    <TextBlock Text="Количество" Foreground="DarkBlue" FontWeight="Bold"/>
                    <TextBox x:Name="txtQuantityProduct" Text="{Binding QuantityProduct, Mode=TwoWay}" Margin="2"/>
                </StackPanel>
                
                <!-- НОВАЯ КНОПКА для отображения в формате рисунка 1 -->
                <Button Grid.Row="1" Content="Показать в формате" 
                        Click="ShowFormattedData_Click" 
                        Margin="5" Height="25" 
                        Background="LightGreen"/>
            </Grid>
        </GroupBox>

        <!-- 3. Простая привязка ComboBox -->
        <GroupBox Grid.Column="2" Grid.Row="1" Header="3. Простая привязка ComboBox" Margin="5">
            <StackPanel Orientation="Vertical">
                <TextBlock Text="Выберите продукт:" FontWeight="Bold" Margin="2"/>
                <ComboBox x:Name="cmbProduct" 
                          DisplayMemberPath="nameProduct" 
                          SelectedValuePath="idProduct"
                          SelectionChanged="CmbProduct_SelectionChanged"
                          Margin="2"/>
                <TextBlock Text="Выбранный ID:" FontWeight="Bold" Margin="2,10,2,2"/>
                <TextBox x:Name="txtSelectedId" IsReadOnly="True" Margin="2"/>
            </StackPanel>
        </GroupBox>

        <!-- 4. Сложная привязка ComboBox -->
        <GroupBox Grid.Column="3" Grid.Row="1" Header="4. Сложная привязка ComboBox" Margin="5">
            <StackPanel x:Name="stDetailCombo" Orientation="Vertical">
                <TextBlock Text="ID Продажи" FontWeight="Bold"/>
                <TextBox Text="{Binding IdSale, Mode=TwoWay}" Margin="2"/>
                <TextBlock Text="Продукт:" FontWeight="Bold"/>
                <ComboBox x:Name="cmbProductDetail" 
                          DisplayMemberPath="nameProduct" 
                          SelectedValuePath="idProduct"
                          SelectedValue="{Binding IdProductDetailSale, Mode=TwoWay}"
                          Margin="2"/>
                <TextBlock Text="Количество:" FontWeight="Bold"/>
                <TextBox Text="{Binding QuantityProduct, Mode=TwoWay}" Margin="2"/>
                <TextBlock Text="Цена за единицу:" FontWeight="Bold"/>
                <TextBox Text="{Binding UnitPrice, Mode=TwoWay}" Margin="2"/>
            </StackPanel>
        </GroupBox>

        <!-- Кнопки управления -->
        <GroupBox Grid.Row="2" Grid.ColumnSpan="4" Header="Управление данными" Margin="5">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Кнопки управления -->
                <Button Grid.Row="0" Grid.Column="0" Content="Загрузить первый Product" 
                        Click="LoadFirstProduct_Click" Margin="5" Height="30"/>
                <Button Grid.Row="0" Grid.Column="1" Content="Загрузить первый SaleDetail" 
                        Click="LoadFirstSaleDetail_Click" Margin="5" Height="30"/>
                <Button Grid.Row="0" Grid.Column="2" Content="Сохранить изменения" 
                        Click="SaveChanges_Click" Margin="5" Height="30"/>
                <Button Grid.Row="0" Grid.Column="3" Content="Показать связанные поля" 
                        Click="ShowRelatedFields_Click" Margin="5" Height="30"/>

                <Button Grid.Row="1" Grid.Column="0" Content="Новый Product" 
                        Click="NewProduct_Click" Margin="5" Height="30"/>
                <Button Grid.Row="1" Grid.Column="1" Content="Новый SaleDetail" 
                        Click="NewSaleDetail_Click" Margin="5" Height="30"/>
                <Button Grid.Row="1" Grid.Column="2" Content="Добавить Product в БД" 
                        Click="AddProduct_Click" Margin="5" Height="30"/>
                <Button Grid.Row="1" Grid.Column="3" Content="Добавить SaleDetail в БД" 
                        Click="AddSaleDetail_Click" Margin="5" Height="30"/>

                <!-- Информационная область -->
                <TextBlock Grid.Row="2" Grid.ColumnSpan="4" x:Name="txtInfo" 
                           Text="Информация о выполненных операциях будет отображаться здесь"
                           Background="LightYellow" Padding="10" Margin="5"
                           TextWrapping="Wrap"/>
            </Grid>
        </GroupBox>

        <!-- Статус -->
        <StatusBar Grid.Row="3" Grid.ColumnSpan="4">
            <StatusBarItem>
                <TextBlock x:Name="statusText" Text="Готов к работе"/>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</Window>
```

---

## Б) Код C#

### MainWindow.xaml.cs - Код-behind с реализацией привязок

```csharp
using System;
using System.Linq;
using System.Windows;
using System.Windows.Controls;
using MilkProductsBinding.Models;
using Microsoft.EntityFrameworkCore;

namespace MilkProductsBinding
{
    public partial class MainWindow : Window
    {
        private SalesContext db = new SalesContext();
        
        // Переменные для новых объектов (видны во всех методах)
        private Product productNew = new Product();
        private SaleDetails detailSaleNew = new SaleDetails();

        public MainWindow()
        {
            InitializeComponent();
            InitializeData();
        }

        private void InitializeData()
        {
            try
            {
                // 3. Простая привязка ComboBox - загружаем список продуктов
                cmbProduct.ItemsSource = db.Product.ToList();
                
                // 4. Сложная привязка ComboBox - загружаем список продуктов
                cmbProductDetail.ItemsSource = db.Product.ToList();

                statusText.Text = "База данных подключена успешно";
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Ошибка инициализации: {ex.Message}", "Ошибка");
            }
        }

        #region 1. Простая привязка данных к TextBox

        private void LoadFirstProduct_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                // Возьмем любую запись из главной таблицы, например первую
                var recProduct = db.Product.First();
                stProduct.DataContext = recProduct;

                txtInfo.Text = $"Загружен продукт: {recProduct.nameProduct}";
                statusText.Text = "Простая привязка выполнена";
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Ошибка: {ex.Message}", "Ошибка");
            }
        }

        #endregion

        #region 2. Сложная привязка данных к TextBox

        private void LoadFirstSaleDetail_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                // Возьмем любую запись из таблицы подчиненной, например первую
                var recDetailProduct = db.DetailSale.Include(d => d.Product).First();
                stDetail.DataContext = recDetailProduct;

                txtInfo.Text = $"Загружена деталь: {recDetailProduct.Product.nameProduct}";
                statusText.Text = "Сложная привязка выполнена";
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Ошибка: {ex.Message}", "Ошибка");
            }
        }

        #endregion

        #region 3. Простая привязка ComboBox

        private void CmbProduct_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (cmbProduct.SelectedValue != null)
            {
                // Получаем выбранное значение
                int articul = Convert.ToInt32(cmbProduct.SelectedValue);
                txtSelectedId.Text = articul.ToString();

                txtInfo.Text = $"Выбран продукт с ID: {articul}";
            }
        }

        #endregion

        #region 5. Доступ к связанным полям

        private void ShowRelatedFields_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                var recProductPriceFirst = db.DetailSale.Include(d => d.Product).First();
                
                // Выбираем наименование по связи
                string nameFirst = recProductPriceFirst.Product.nameProduct;
                
                // Выбираем цену по связи
                decimal priceFirst = recProductPriceFirst.Product.priceProduct;

                txtInfo.Text = $"Связанные поля: {nameFirst}, Цена: {priceFirst:C}";
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Ошибка: {ex.Message}", "Ошибка");
            }
        }

        #endregion

        #region 6. Изменение записи с Mode=TwoWay

        private void SaveChanges_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                // Сохраняем изменения в базу данных
                int changesCount = db.SaveChanges();
                
                txtInfo.Text = $"Сохранено изменений: {changesCount}";
                statusText.Text = $"Сохранено {changesCount} изменений";

                if (changesCount > 0)
                {
                    MessageBox.Show($"Сохранено {changesCount} изменений!", "Успех");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Ошибка сохранения: {ex.Message}", "Ошибка");
            }
        }

        #endregion

        #region 7. Добавление новых записей

        private void NewProduct_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                // Создаем новый объект Product
                productNew = new Product
                {
                    nameProduct = "",
                    priceProduct = 0,
                    Category = "",
                    ExpiryDays = 0
                };

                // Устанавливаем источник – новую запись
                stProduct.DataContext = productNew;

                txtInfo.Text = "Создан новый Product. Заполните поля.";
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Ошибка: {ex.Message}", "Ошибка");
            }
        }

        private void AddProduct_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                if (string.IsNullOrWhiteSpace(productNew.nameProduct))
                {
                    MessageBox.Show("Заполните название продукта!");
                    return;
                }

                // Добавляем новый продукт в контекст
                db.Product.Add(productNew);
                
                // Сохраняем в базу данных
                db.SaveChanges();

                txtInfo.Text = $"Новый продукт добавлен: {productNew.nameProduct}";

                // Обновляем ComboBox
                cmbProduct.ItemsSource = db.Product.ToList();
                cmbProductDetail.ItemsSource = db.Product.ToList();

                MessageBox.Show("Продукт добавлен в БД!", "Успех");
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Ошибка: {ex.Message}", "Ошибка");
            }
        }

        private void NewSaleDetail_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                // Создаем новый объект SaleDetails
                detailSaleNew = new SaleDetails
                {
                    IdSale = 1,
                    IdProductDetailSale = 0,
                    QuantityProduct = 0,
                    UnitPrice = 0
                };

                // Устанавливаем источник – новую запись
                stDetailCombo.DataContext = detailSaleNew;

                txtInfo.Text = "Создан новый SaleDetails. Заполните поля.";
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Ошибка: {ex.Message}", "Ошибка");
            }
        }

        private void AddSaleDetail_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                if (detailSaleNew.IdProductDetailSale == 0)
                {
                    MessageBox.Show("Выберите продукт!");
                    return;
                }

                // Добавляем новую деталь продажи в контекст
                db.DetailSale.Add(detailSaleNew);
                
                // Сохраняем в базу данных
                db.SaveChanges();

                txtInfo.Text = $"Новая деталь продажи добавлена";

                MessageBox.Show("SaleDetail добавлен в БД!", "Успех");
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Ошибка: {ex.Message}", "Ошибка");
            }
        }

        #endregion

        protected override void OnClosed(EventArgs e)
        {
            db?.Dispose();
            base.OnClosed(e);
        }
    }
}
```

---

## В) Скриншоты выполненных заданий

### 1. Простая привязка данных к TextBox
![Простая привязка](screenshots/simple_binding.png)
*Демонстрация привязки полей Product к TextBox элементам*

### 2. Сложная привязка данных к TextBox
![Сложная привязка](screenshots/complex_binding.png)
*Демонстрация привязки SaleDetails с доступом к связанным полям Product*

### 3. Простая привязка ComboBox
![Простая привязка ComboBox](screenshots/simple_combobox.png)
*ComboBox с отображением списка продуктов и получением выбранного ID*

### 4. Сложная привязка ComboBox
![Сложная привязка ComboBox](screenshots/complex_combobox.png)
*ComboBox с двусторонней привязкой к полю IdProductDetailSale*

### 5. Доступ к связанным полям
![Связанные поля](screenshots/related_fields.png)
*Демонстрация доступа к полям связанной таблицы через навигационные свойства*

### 6. Изменение записи с Mode=TwoWay
![Изменение записи](screenshots/twoway_binding.png)
*Изменение данных в TextBox с автоматическим обновлением объекта*

### 8. Скриншот новой функциональности
![Отображение в формате рисунка 1](screenshots/formatted_display.png)
*Новое окно с отображением данных в формате как на рисунке 1*

---

## Выводы

В ходе выполнения лабораторной работы были изучены и реализованы:

1. **Простые привязки данных** - связывание свойств объектов с элементами управления
2. **Сложные привязки данных** - доступ к связанным данным через навигационные свойства
3. **Привязки ComboBox** - простые и сложные варианты с DisplayMemberPath и SelectedValuePath
4. **Двусторонние привязки** - Mode=TwoWay для автоматического обновления данных
5. **Работа с контекстом данных** - установка DataContext для групп элементов
6. **Добавление новых записей** - создание объектов и сохранение в базу данных
7. **НОВАЯ ФУНКЦИОНАЛЬНОСТЬ** - отображение данных в отдельном окне в формате рисунка 1

**Дополнительно реализовано:**
- Кнопка "Показать в формате" во второй секции (сложная привязка SaleDetails)
- Отдельное окно DetailDisplayWindow для отображения данных в формате как на рисунке 1
- Автоматическое заполнение полей из привязанных данных или TextBox элементов

Все задания технического задания выполнены успешно. Приложение демонстрирует различные типы привязок данных в WPF с использованием Entity Framework Core, включая дополнительную функциональность отображения данных в специальном формате.

---

**Дата выполнения:** [Дата]  
**Подпись студента:** _______________